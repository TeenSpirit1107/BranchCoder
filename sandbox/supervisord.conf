[unix_http_server]
file=/tmp/supervisor.sock   ; Path of UNIX socket file, supervisor uses it to listen
chmod=0770                  ; Socket file permissions
chown=ubuntu:ubuntu         ; Socket file owner and group

[supervisord]
logfile=/dev/stdout         ; Main log file output to standard output
logfile_maxbytes=0          ; No limit on log size
loglevel=info               ; Log level
pidfile=/tmp/supervisord.pid ; Path of pidfile
nodaemon=true                ; Need to run in foreground in Docker
minfds=1024                  ; Minimum value of open file descriptors
minprocs=200                 ; Minimum number of processes
autoshutdown=true            ; Auto exit after all services stop

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock ; Socket connection to supervisord

; Xvfb virtual display configuration
[program:xvfb]
command=bash -c "rm -f /tmp/.X1-lock && Xvfb :1 -screen 0 1280x1029x24"
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=DISPLAY=:1
priority=10

; socat port forwarding configuration
[program:socat]
command=socat TCP-LISTEN:9222,bind=0.0.0.0,fork,reuseaddr TCP:127.0.0.1:8222
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=30
startsecs=2

; VNC service configuration
[program:x11vnc]
command=x11vnc -display :1 -nopw -listen 0.0.0.0 -xkb -forever -rfbport 5900
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=DISPLAY=:1
priority=40
startsecs=3

; Websockify configuration - Convert VNC to WebSocket
[program:websockify]
command=websockify 0.0.0.0:5901 localhost:5900
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=45
startsecs=3

; FastAPI application configuration
[program:app]
command=python -m uvicorn app.main:app --host 0.0.0.0 --port 8080 %(ENV_UVI_ARGS)s
directory=/app
user=ubuntu
autostart=true
autorestart=true
stdout_logfile=/tmp/app.log
stdout_logfile_maxbytes=10MB
stderr_logfile=/tmp/app.log
stderr_logfile_maxbytes=10MB
environment=HOME=/home/ubuntu,DISPLAY=:1,PLAYWRIGHT_BROWSERS_PATH=/ms-playwright,PATH=/home/ubuntu/.local/bin:/opt/py313/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
priority=50

; VS Code Server configuration
[program:code-server]
command=code-server --config /home/ubuntu/.config/code-server/config.yaml /home/ubuntu
directory=/home/ubuntu
user=ubuntu
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=HOME=/home/ubuntu,PATH=/usr/local/bin:/usr/bin:/bin:/home/ubuntu/.local/bin
priority=60

; Group configuration, can start or stop multiple programs at once
[group:services]
programs=xvfb,socat,x11vnc,websockify,app,code-server 